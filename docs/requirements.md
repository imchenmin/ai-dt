# C/C++ 单元测试生成工具需求文档

## 项目概述

本项目旨在开发一个基于Python的C/C++单元测试自动生成工具，作为现有单元测试的快速补充方案。该工具将利用AI模型在资源受限的环境下（如夜间运行）生成高质量的单元测试代码。

## 技术约束

### 模型限制
- **主要模型**: 上下文窗口16K
- **备选模型**: 通义千问3（200多B参数版本）
- **最大上下文**: 20K tokens
- **运行环境**: 公司内部资源有限，主要在夜间运行

### 测试框架
- **C语言/C++语言**: 使用Google Test (gtest)框架 + MockCpp
- **不使用其他测试框架**

## 核心功能需求

### 1. 项目结构分析
- 读取项目配置compile_commands.json，了解每个C/C++文件的：
  - 依赖的头文件列表
  - 编译指令和参数
  - 文件间的依赖关系

### 2. 可测试函数识别

#### C语言函数筛选规则
- ✅ **可测试**: 非static函数
- ❌ **不可测试**: static函数

#### C++语言函数筛选规则
- ✅ **可测试**: 
  - 公有(public)方法
  - 静态(static)方法
  - private函数(通过符号表劫持)

### 3. 上下文信息提取

为每个待测试函数收集以下信息（最小化原则）：

#### 3.1 函数基本信息
- 函数签名（参数类型、返回值类型）
- 函数所在文件位置

#### 3.2 依赖分析
- **调用的函数**: 函数内部调用的其他函数列表
- **函数声明**: 被调用函数的声明和定义
- **使用的宏**: 函数中使用的宏定义
- **数据结构**: 函数参数和返回值涉及的结构体/类定义

#### 3.3 调用关系
- **谁调用了它**: 在整个项目中搜索调用该函数的位置
- **调用上下文**: 了解函数的典型使用场景

### 4. 测试代码生成

#### 4.1 生成策略
- 每次运行生成全新的测试文件
- 基于收集的上下文信息生成测试用例
- 包含边界条件、异常情况、正常流程的测试

#### 4.2 Mock处理
- 对于被测函数调用的外部函数，生成相应的Mock
- 提供函数签名信息以便正确Mock

#### 4.3 测试规范
- 参考现有测试代码的编写规范
- 保持代码风格一致性

### 5. 可追溯性要求

每次生成的测试都应该包含：
- 生成时间戳
- 基于的源代码版本信息
- 使用的AI模型和参数
- 生成过程中的关键决策记录

## 输入输出规格

### 输入
1. **项目配置文件**: 描述文件依赖和编译信息
2. **目标文件/文件夹**: 需要生成测试的C/C++代码
3. **现有测试规范**: 用作生成模板的参考

### 输出
1. **测试文件**: 符合MockCpp/gtest框架的测试代码
2. **编译脚本**: 用于编译和运行测试的脚本
3. **测试报告**: 生成过程的详细记录

## 实现优先级

### Phase 1: 核心功能
1. 项目结构解析器
2. 函数识别和筛选
3. 基本的测试代码生成

### Phase 2: 增强功能
1. 智能上下文提取
2. Mock生成
3. 测试规范集成

### Phase 3: 优化功能
1. 性能优化
2. 可追溯性完善
3. 用户界面改进

## 技术架构建议

```
ai-dt/
├── src/
│   ├── parser/          # 代码解析模块
│   ├── analyzer/        # 函数分析模块
│   ├── generator/       # 测试生成模块
│   └── utils/           # 工具函数
├── config/              # 配置文件
├── templates/           # 测试模板
├── tests/               # 工具自身的测试
└── docs/                # 文档
```

## 下一步行动

1. 确认需求理解是否准确
2. 设计详细的技术方案
3. 创建项目基础结构
4. 开始核心模块开发