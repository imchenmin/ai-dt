# 工作日志：提示词工程系统的深度重构与调试

## 日期: 2025-08-24
## 负责人: Gemini

## 1. 任务背景
在成功优化了单个提示词（Prompt）后，我们认识到问题的根源在于生成提示词的程序本身。本次任务旨在深入代码，对整个提示词工程（Prompt Engineering）的流水线进行一次彻底的重构与优化。

## 2. 核心问题诊断

通过对 `prompt_templates.py` 和 `context_compressor.py` 的初步分析，我们发现提示词质量不高的核心原因有两个：

1.  **上下文信息不足**：分析器仅向提示词模板传递了依赖项的**名称**（如数据结构名、函数名），而没有提供它们的**源码定义**和**完整函数声明**。
2.  **指令模糊**：提示词中缺少对外部函数**可Mock性**的分析，LLM无法判断哪些函数可以被Mock。

## 3. 重构与调试的迭代历程

为了解决上述问题，我们经历了一个多阶段、不断深入的迭代修复过程。

### 第一阶段：重构上下文压缩器与提示词模板

*   **目标**：让提示词能够展示更丰富的上下文。
*   **实施**：
    1.  修改了 `context_compressor.py`，使其能够处理（当时设想中）由上游分析器提供的、包含完整定义的依赖项数据结构。
    2.  重构了 `prompt_templates.py`，设计了全新的五段式提示词结构，并加入了角色扮演、思维链等高级技巧。
*   **结论**：奠定了新版提示词的骨架，但意识到问题的真正根源在上游的分析器。

### 第二阶段：深度重构分析器 (`clang_analyzer.py`)

这是本次任务的核心和难点所在，我们反复进行了多次尝试：

*   **尝试 #1：提取数据结构定义**
    *   **问题**：发现仅处理 `STRUCT_DECL` 无法覆盖 `typedef struct` 的场景，并且遗漏了对 `TYPE_REF`（类型引用）的处理。
    *   **修复**：加入了对 `TYPE_REF` 的处理，使其能够通过引用追溯到定义，成功提取出 `HashTable` 的源码。

*   **尝试 #2：提取函数声明与可Mock性（用户的关键需求）**
    *   **问题**：在提取被调用函数的参数列表时，最初的几次尝试（如 `get_arguments()`）对于只有头文件声明的函数非常不稳定，导致参数显示为 `(...)`。
    *   **调试**：通过向提示词中注入原始JSON数据进行“断点调试”，最终定位到是 `context_compressor.py` 在压缩数据时，错误地丢弃了我们新提取的 `declaration` 和 `is_mockable` 字段。
    *   **修复**：在定位到这个隐蔽的Bug后，我们修复了 `context_compressor.py`，确保了包含完整函数声明和可Mock状态的数据能被完整地传递到提示词模板。

### 第三阶段：优化开发工作流 (`main.py`)

*   **背景**：用户提出，反复进行真实的LLM调用来测试提示词，成本高且效率低下。
*   **实施**：
    1.  在 `src/main.py` 中添加了 `--prompt-only` 命令行参数。
    2.  修改了程序逻辑，当此标志被激活时，程序将使用 `MockLLMClient` 来代替真实的LLM请求，从而实现“只生成提示词”的“干跑”（Dry Run）模式。
    3.  修复了 `MockLLMClient` 的接口兼容性问题，使其能适配新的调用方式。
*   **价值**：极大地提升了调试效率，是本次重构中一个非常重要的工程实践优化。

## 4. 最终成果

经过上述所有重构与修复，我们最终成功地建立了一套全新的提示词工程系统。在最后一次测试中，为 `hash_table_put` 函数生成的提示词，已经完全达到了我们的所有预期：

1.  **结构清晰**：采用了专业的五段式结构。
2.  **上下文充实**：包含了关键数据结构 `HashTable` 的源码定义。
3.  **依赖分析精准**：成功分析了所有被调用的函数，并给出了它们的**完整声明**和**可Mock状态**的明确指导。

```markdown
# 4. 测试生成要求 (Test Generation Requirements)
...
2.  **依赖函数分析:**
    *   `size_t default_hash_function(const char * key, size_t capacity);` - **可以Mock**
    *   `int strcmp(...);` - **可以Mock**
    *   `HashNode * create_hash_node(const char * key, int value);` - **不可Mock (static)**
...
```

## 5. 总结

本次任务不仅是对提示词内容的优化，更是对整个底层分析与生成流水线的一次深度重构。通过“断点调试”等方法，我们精准地定位并修复了数据流中的多个隐蔽Bug，最终的成果是一个健壮、可调试、高效的提示词工程系统。